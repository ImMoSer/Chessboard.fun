# Техническое задание: Дебаггинг и рефакторинг URL в режиме "Песочница"

## 1. Исходная задача

Реализовать возможность выбора шахматного движка в режиме "Песочница" через URL.

**Требования:**
- URL должен поддерживать формат: `/sandbox/play/<engine_id>/<fen>`.
- При отсутствии `engine_id` в URL, должен использоваться движок по умолчанию (`SF_2200` для гостей, сохраненный движок для авторизованных пользователей).
- При попытке неавторизованного пользователя использовать серверный движок, должно появляться диалоговое окно с предложением авторизоваться или использовать движок по умолчанию.
- При смене движка через UI, URL должен динамически обновляться.
- При обновлении страницы с `engine_id` в URL, должен загружаться именно этот движок.

## 2. Проделанная работа

Были внесены изменения в несколько файлов для реализации этой функциональности:
- **`src/router/index.ts`**: Добавлен новый маршрут `sandbox-with-engine` для поддержки `engine_id` в URL.
- **`src/services/GameplayService.ts`**: Добавлена логика для определения типа движка (локальный/серверный).
- **`src/stores/controls.store.ts`**: Модифицирована функция `setEngine` для обновления URL при смене движка.
- **`src/views/SandboxView.vue`**: Реализована основная логика по обработке URL, проверке авторизации и отображению диалоговых окон.
- **`src/components/TopInfoPanel.vue`**: Исправлено отображение селектора движков для нового маршрута.

## 3. Обнаруженные проблемы

После внесения изменений возникли две критические ошибки:

1.  **Некорректный редирект при обновлении:** При обновлении страницы с URL, содержащим `engine_id` (например, `.../MOZER_2000/...`), URL принудительно изменялся на дефолтный (`.../SF_2200/...`).
2.  **Перестал работать выбор движка:** При выборе другого движка в селекторе, URL перестал обновляться, и движок не менялся.

## 4. Анализ и решение

Анализ логов и кода выявил первопричину обеих проблем.

**Корень проблемы:**
В файле `src/stores/game.store.ts`, внутри действия `startSandboxGame`, присутствовал вызов `controlsStore.setSandboxEngine()`. Это действие, в свою очередь, безусловно вызывало `setEngine('SF_2200')`, жестко устанавливая движок по умолчанию при каждом запуске или перезапуске игры в "песочнице".

Эта строка кода являлась наследием старой логики и конфликтовала с новой системой управления движком через URL. Она вызывала состояние гонки, которое приводило к сбросу выбора пользователя и перезаписи URL.

**Произведенное исправление:**
Проблема была решена путем удаления строки `controlsStore.setSandboxEngine()` из функции `startSandboxGame` в файле `src/stores/game.store.ts`.

**Ожидаемое поведение после исправления:**
Теперь `startSandboxGame` больше не вмешивается в выбор движка. Управление полностью передано компоненту `SandboxView.vue` и `controls.store.ts`, которые корректно работают с URL как с единственным источником истины. Обновление страницы должно сохранять выбранный в URL движок, а переключение через селектор должно корректно обновлять URL.
