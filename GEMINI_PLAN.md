# План: Реализация режима "Песочница" (Sandbox)

**Цель:** Создать новый игровой режим "Песочница", который позволяет пользователям играть против заданного движка из любой FEN-позиции, полученной по специальной ссылке или введенной вручную.

**Ключевые возможности:**
- Запуск игры из URL вида `/sandbox/play/{FEN}`.
- **Доступен неавторизованным пользователям.**
- Игра всегда идет против одного и того же локального движка: `SF_2200: 'Rbleipzig 2350+'`.
- Возможность вставить свой FEN в специальное поле и начать игру.
- При изменении FEN в поле ввода, URL должен обновляться для возможности поделиться ссылкой.
- **Валидация FEN и отображение предупреждения во всплывающем окне при ошибке.**
- Кнопки "Сдаться", "Рестарт", "Поделиться" должны быть адаптированы для нового режима.
- Анализ недоступен во время игры, но становится доступен после сдачи.

---

## Детализированный План Реализации

### Шаг 1: Создание маршрута и нового представления (View)

1.  **Обновить `src/router/index.ts`**:
    *   Добавить новый маршрут для "Песочницы". **Важно:** убедиться, что на новый маршрут не распространяются защитные навигационные гарды (navigation guards), требующие аутентификации.
        ```typescript
        {
          path: '/sandbox',
          name: 'sandbox-base',
          redirect: '/sandbox/play/rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR_w_KQkq_-_0_1',
        },
        {
          path: '/sandbox/play/:fen(.+)', // :fen(.+) для поддержки FEN со слэшами
          name: 'sandbox',
          component: () => import('../views/SandboxView.vue'),
        }
        ```

2.  **Создать файл `src/views/SandboxView.vue`**:
    *   Это будет основной компонент для нового режима, использующий `GameLayout.vue`.

### Шаг 2: Реализация логики запуска игры в `game.store`

1.  **Модифицировать `src/stores/game.store.ts`**:
    *   Добавить `gameMode: 'sandbox' | ...` в состояние.
    *   Создать новое действие `startSandboxGame(rawFen: string)`.
    *   Это действие будет выполнять следующие шаги:
        1.  Преобразовать `rawFen` из URL (с `_`) в стандартный FEN (с пробелами).
        2.  **Провести валидацию FEN.** (Предположительно с помощью `chess.js`, если он есть в проекте). 
        3.  Если FEN невалиден, вызвать действие в `ui.store` для отображения модального окна с ошибкой и прервать выполнение.
        4.  Если FEN валиден, установить `gameMode` в `'sandbox'`, загрузить позицию, принудительно установить оппонента `SF_2200` и сбросить состояние игры.
        5.  **Действие не должно требовать авторизованного пользователя.**

2.  **Вызвать `startSandboxGame` в `SandboxView.vue`**:
    *   В хуке `onMounted` и в `watch` на параметр `:fen` вызывать `gameStore.startSandboxGame(fen)`. 

### Шаг 3: Создание UI для ввода FEN

1.  **Добавить в `SandboxView.vue`**:
    *   Поле `<input>` для FEN и кнопку "Играть".
    *   По клику на кнопку выполнять `router.push('/sandbox/play/' + newFen.value)`, где `newFen` это FEN из инпута с заменой пробелов на `_`. Это обновит URL и вызовет логику из Шага 2.

### Шаг 4: Адаптация существующих контролов

*   **Важно:** все действия контролов в режиме `sandbox` не должны зависеть от состояния пользователя.

1.  **Обновить `src/stores/controls.store.ts`**:
    *   В действии `onRestart` добавить проверку: если `gameStore.gameMode === 'sandbox'`, перезапускать игру с исходным FEN из URL.

2.  **Обновить `src/components/ControlPanel.vue`**:
    *   Скрыть кнопку "Анализ" (`v-if`), когда идет игра в режиме "Песочница".

3.  **Обновить `src/services/share.service.ts`**:
    *   Добавить логику для генерации ссылки `https://chessboard.fun/sandbox/play/{current_fen}`.

### Шаг 5: Финальная проверка

1.  **Проверить типы**: `pnpm type-check`.
2.  **Ручное тестирование**:
    *   **Проверить доступ в режиме инкогнито.**
    *   **Ввести некорректный FEN в URL и в поле ввода, убедиться, что появляется всплывающее окно с предупреждением.**
    *   Перейти по прямой ссылке с валидным FEN, убедиться, что игра началась против нужного движка.
    *   Проверить работу кнопок "Сдаться", "Рестарт" и "Поделиться".
